## Real Time

В приложении реализовано обновление доски в режиме реального времени с помощью веб-сокетов. Это необходимо ввиду того, что доска представляет собой интерактивное пространство для совместной работы где несколько пользователей могут взаимодействовать одновременно. Действия всех участников должны быть синхронизированы для поддержки доски в актуальном состоянии.

**Запуск**

```bash
# start web socket server
$ bun wss:start
```

**Формат взаимодействия**

Сервер и клиент обмениваются сообщениями в JSON формате, которые могут содержать следующие поля:

```
  type: 'unsubscribe'; // тип операции (подписка / отписка / сообщение)
  tenantId: string; // id арендатора
  initiatorId: string; // id пользователя, инциировавшего операцию
  action: string; // тип события (создание/удаление задачи или колонки)
  data: {} // измененные данные (структура полностью соответствует структуре ответа REST-запроса, описанного в Swagger)
```

**Клиентская часть**

Соединение с WS-сервером устанавливается через провайдер `SocketProvider`, далее с помощью компонента-обработчика `TeamSocketHandler` через обычное сообщение производится подписка на текущего tenant. При размонтировании компонента или разрыве WS-соединения производится отписка. Таким образом формируется логический канал взаимодействия, в рамках которого клиент будет получать сообщения относящиеся только к заявленному tenant. Обновление данных в пользовательском интерфейсе происходит через кэш, предоствляемый `Tanstack Query`. Предварительно мы с помощью хука `useSubcription` подписываем на определенное действие (Например `TASK_CREATED`). Если действие в сообщении соответствует указанному, то вызывается переданная функция-обработчик, которая уже и вносит изменения в кэш.

\*Важно отметить, что сервер, отправляя сообщение, не знает, какие параметры запроса установлены на клиенте. Поэтому, на клиенте дополнительно осуществляется фильтрация по всем заявленным параметрам. Это дает возможность не отображать данные, не соответствующие фильтру, и отобразить их позднее, если они будут обновлены (Например, на клиенте фильтр на зеленые задачи. Другой пользователь создает задачу и после красит её в зеленый. Эта задача сразу же отобразится у первого клиента)

\*По необходимости можно создать ещё компоненты-обработчики или соединения с другими WS-серверами.

**Серверная часть**

Управление WS-соединения осуществляется через класс `WsManager`. Он сохраняет в память приложения данные в нескольких видах:

1. Клиент - Соединение
2. Арендатор - Клиенты (быстрый поиск всех клиентов определенного арендатора)
3. Клиент - Арендаторы (быстрый поиск всех арендаторов определенного клиента)

Это позволяет создавать логические каналы взаимодействия (описано выше).

WS-сервер подписывается на Redis-канал, куда приходят события, отправляемые серверной частью Next.js (в REST "ручке") сразу после успешного завершения SQL-операции. Сразу после сообщения перенаправляется подписчикам канала.

Все сообщения проходят строгую валидацию через Zod-схемы.
